
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>envlib.contrail &#8212; envlib V0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for envlib.contrail</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">metpy</span> <span class="kn">import</span> <span class="n">calc</span>
<span class="kn">from</span> <span class="nn">metpy.units</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">envlib.database</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="get_pcfa"><a class="viewcode-back" href="../../modules.html#envlib.contrail.get_pcfa">[docs]</a><span class="k">def</span> <span class="nf">get_pcfa</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">,</span> <span class="o">**</span><span class="n">problem_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the presistent contrail formation areas (pcfa) which is used to calculate aCCF of (day/night) contrails.</span>

<span class="sd">    :param ds: Dataset openned with xarray.</span>
<span class="sd">    :type ds: Dataset</span>

<span class="sd">    :param member: Detemines the presense of ensemble forecasts in the given dataset.</span>
<span class="sd">    :type member: bool</span>

<span class="sd">    :returns pcfa: Presistent contrail formation areas.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">confg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rh_threshold&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;rw_threshold&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;temp_threshold&#39;</span><span class="p">:</span> <span class="n">cont_temp_thr</span><span class="p">,</span> <span class="s1">&#39;sep_ri_rw&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">confg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">problem_config</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\033</span><span class="s1">[93m UserWarning: For this configuration formation of persistent contrails is possible, if temperatures are low enough (below 235K) and relative humidity (with respect to ice) is above or at </span><span class="si">{}</span><span class="s1">%. However keep in mind that the threshold value for the relative humidity varies with the used forecast model and its resolution. In order to choose the appropriate threshold value, you should read the details given in Section 5.1 of the connected publication of Dietm√ºller et al. 2022 </span><span class="se">\033</span><span class="s1">[93m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">confg</span><span class="p">[</span><span class="s1">&#39;rh_threshold&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

    <span class="n">formation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">presistancy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">ri</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">confg</span><span class="p">[</span><span class="s1">&#39;rw_threshold&#39;</span><span class="p">]:</span>
        <span class="p">[</span><span class="n">ri</span><span class="p">,</span> <span class="n">rw</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_relative_hum</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
        <span class="p">[</span><span class="n">rw_thr</span><span class="p">,</span> <span class="n">temp_thr</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_cont_form_thr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">confg</span><span class="p">[</span><span class="s1">&#39;temp_threshold&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;varing&#39;</span><span class="p">:</span>
            <span class="n">temp_thr</span> <span class="o">=</span> <span class="n">confg</span><span class="p">[</span><span class="s1">&#39;temp_threshold&#39;</span><span class="p">]</span>
        <span class="n">formation</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">temp_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">formation</span><span class="p">[</span><span class="n">rw</span> <span class="o">&lt;</span> <span class="n">rw_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">formation</span><span class="p">[</span><span class="n">rw</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">confg</span><span class="p">[</span><span class="s1">&#39;temp_threshold&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;varing&#39;</span><span class="p">:</span>
        <span class="p">[</span><span class="n">rw_thr</span><span class="p">,</span> <span class="n">temp_thr</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_cont_form_thr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">temp_thr</span> <span class="o">=</span> <span class="n">confg</span><span class="p">[</span><span class="s1">&#39;temp_threshold&#39;</span><span class="p">]</span>
        <span class="n">formation</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">temp_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">confg</span><span class="p">[</span><span class="s1">&#39;sep_ri_rw&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confg</span><span class="p">[</span><span class="s1">&#39;rw_threshold&#39;</span><span class="p">]:</span>
        <span class="p">[</span><span class="n">ri</span><span class="p">,</span> <span class="n">rw</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_relative_hum</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
    <span class="c1"># persistency conditions</span>
    <span class="n">presistancy</span><span class="p">[</span><span class="n">ri</span> <span class="o">&gt;=</span> <span class="n">confg</span><span class="p">[</span><span class="s1">&#39;rh_threshold&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pcfa</span> <span class="o">=</span> <span class="n">formation</span> <span class="o">*</span> <span class="n">presistancy</span>
    <span class="k">return</span> <span class="n">pcfa</span></div>


<div class="viewcode-block" id="get_cont_form_thr"><a class="viewcode-back" href="../../modules.html#envlib.contrail.get_cont_form_thr">[docs]</a><span class="k">def</span> <span class="nf">get_cont_form_thr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the thresholds of temperature and relative humidity over water needed for determining the</span>
<span class="sd">    formation criteria of contrails.</span>

<span class="sd">    :param ds: Dataset openned with xarray.</span>
<span class="sd">    :type ds: Dataset</span>

<span class="sd">    :param member: Detemines the presense of ensemble forecasts in the given dataset.</span>
<span class="sd">    :type member: bool</span>

<span class="sd">    :returns rcontr: Thresholds of relative humidity over water.</span>
<span class="sd">    :rtype: numpy.ndarray</span>

<span class="sd">    :returns TLM_e: Thresholds of temperature.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rcontr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">n_l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">member</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">TLM_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.6222</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="mi">43</span> <span class="o">*</span> <span class="mf">1e6</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">EI_H2O</span> <span class="o">=</span> <span class="mf">1.25</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="mi">1004</span>
    <span class="n">eL_T</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">T</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">6096.9385</span> <span class="o">/</span> <span class="n">T</span> <span class="o">+</span> <span class="mf">16.635794</span> <span class="o">*</span> <span class="n">shape</span> <span class="o">-</span> <span class="mf">2.711193</span> <span class="o">*</span> <span class="mf">1e-2</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span>
                            <span class="mf">1.673952</span> <span class="o">*</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.433502</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_l</span><span class="p">):</span>
        <span class="n">lvl</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">lvl</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">EI_H2O</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">P</span> <span class="o">/</span> <span class="n">eps</span> <span class="o">/</span> <span class="n">Q</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span>
        <span class="n">TLM</span> <span class="o">=</span> <span class="o">-</span><span class="mf">46.46</span> <span class="o">+</span> <span class="mf">9.43</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">G</span> <span class="o">-</span> <span class="mf">0.053</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.720</span> <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">G</span> <span class="o">-</span> <span class="mf">0.053</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="k">if</span> <span class="n">member</span><span class="p">:</span>
            <span class="n">TLM_e</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">*</span> <span class="n">TLM</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">rcontr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="p">(</span><span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="n">TLM_e</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">eL_T</span><span class="p">(</span><span class="n">TLM_e</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span> <span class="o">/</span> <span class="n">eL_T</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TLM_e</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">*</span> <span class="n">TLM</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">rcontr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="p">(</span><span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="n">TLM_e</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">eL_T</span><span class="p">(</span><span class="n">TLM_e</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span> <span class="o">/</span> <span class="n">eL_T</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rcontr</span><span class="p">,</span> <span class="n">TLM_e</span></div>


<div class="viewcode-block" id="get_relative_hum"><a class="viewcode-back" href="../../modules.html#envlib.contrail.get_relative_hum">[docs]</a><span class="k">def</span> <span class="nf">get_relative_hum</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">,</span> <span class="n">intrp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the relative humidities over ice and water from the provided relative humidity within ECMWF</span>
<span class="sd">    dataset. In ECMWF data, Relative humidity is defined with respect to saturation of the mixed phase: i.e. with</span>
<span class="sd">    respect to saturation over ice below -23C and with respect to saturation over water above 0C. In the regime in</span>
<span class="sd">    between a quadratic interpolation is applied.</span>

<span class="sd">    :param ds: Dataset openned with xarray.</span>
<span class="sd">    :type ds: Dataset</span>

<span class="sd">    :param member: Detemines the presense of ensemble forecasts in the given dataset.</span>
<span class="sd">    :type member: bool</span>

<span class="sd">    :returns rcontr: Thresholds of relative humidity over water.</span>
<span class="sd">    :rtype: numpy.ndarray</span>

<span class="sd">    :returns TLM_e: Thresholds of temperature.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Calculation of RH over water from specific humidity:</span>

    <span class="n">rw_q</span> <span class="o">=</span> <span class="n">get_rw_from_specific_hum</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>

    <span class="c1"># Conversion to celsius:</span>

    <span class="n">t_c</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="mf">273.15</span>

    <span class="c1"># Where interpolation is done (i.e. -23 &lt; T(celsius) &lt; 0)</span>

    <span class="n">r_intp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t_c</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">r_intp</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">r_intp</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># ri: relative humidity over ice</span>
    <span class="c1"># rw: relative humidity over water</span>

    <span class="n">ri</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rw</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="sd">&quot;&quot;&quot; Dividing relative humidity over water and ice from the given relative and specific humidity (ECMWF data)&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">23</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; if there is temperature lower than -23, the relative humidity is</span>
<span class="sd">         over ice, so in this case, the relative humidity over water is calculated by equating partial</span>
<span class="sd">         pressure of water vapour, by means of p_h2o = RH(i)*p_sat(i) = RH(w)*p_sat(w)!!&quot;&quot;&quot;</span>

        <span class="n">rw</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">23</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">6.1162</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">22.577</span> <span class="o">*</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">23</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">273.78</span> <span class="o">+</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">23</span><span class="p">])))</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">6.0612</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">18.102</span> <span class="o">*</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">23</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">249.52</span> <span class="o">+</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">23</span><span class="p">])))</span>
        <span class="sd">&quot;&quot;&quot;Set r over 100 equal to 100 for Schumman formula, since at r = 100, TLM = TLC&quot;&quot;&quot;</span>

        <span class="n">rw</span><span class="p">[</span><span class="n">rw</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; if there is temperature higher than 0, the relative humidity is</span>
<span class="sd">            over water, so in this case, the relative humidity over ice is calculated by equating partial</span>
<span class="sd">            pressure of water vapour, by means of p_h2o = RH(i)*p_sat(i) = RH(w)*p_sat(w)!!&quot;&quot;&quot;</span>

        <span class="n">ri</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">6.0612</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">18.102</span> <span class="o">*</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">249.52</span> <span class="o">+</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])))</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">6.1162</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">22.577</span> <span class="o">*</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">273.78</span> <span class="o">+</span> <span class="n">t_c</span><span class="p">[</span><span class="n">t_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">intrp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t_c</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot; if there is temperature between -23 and 0, a quadratic interpolation between relative temperature has been</span>
<span class="sd">                given. In this case, the relative humidity over water obtained from specific humidity is used for RH over</span>
<span class="sd">                water, an then, it is used for conversion to RH over ice&quot;&quot;&quot;</span>

            <span class="n">rw</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rw_q</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ri</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rw</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="mf">6.0612</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">18.102</span> <span class="o">*</span> <span class="n">t_c</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">249.52</span> <span class="o">+</span> <span class="n">t_c</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])))</span> <span class="o">/</span> <span class="p">(</span>
                                      <span class="mf">6.1162</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">22.577</span> <span class="o">*</span> <span class="n">t_c</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">273.78</span> <span class="o">+</span> <span class="n">t_c</span><span class="p">[</span><span class="n">r_intp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rw</span></div>


<div class="viewcode-block" id="potential_con_cir_cov"><a class="viewcode-back" href="../../envlib.html#envlib.contrail.potential_con_cir_cov">[docs]</a><span class="k">def</span> <span class="nf">potential_con_cir_cov</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">r_crit</span><span class="p">,</span> <span class="n">r_ice</span><span class="p">):</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">t_contr</span> <span class="o">=</span> <span class="n">T_contr</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="c1"># Define paramters</span>
    <span class="n">r_nuc</span> <span class="o">=</span> <span class="mf">2.349</span> <span class="o">-</span> <span class="p">(</span><span class="n">T</span> <span class="o">/</span> <span class="mi">259</span><span class="p">)</span>
    <span class="n">r_crit</span> <span class="o">=</span> <span class="n">r_crit</span>
    <span class="n">r_sat</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">r_cc</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_crit</span> <span class="o">*</span> <span class="n">r_sat</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">r_nuc</span><span class="p">)</span>

    <span class="c1"># saturated the relative humidity over ice</span>
    <span class="n">R_s</span> <span class="o">=</span> <span class="n">r_ice</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">R_s</span><span class="p">[</span><span class="n">r_ice</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># calculation of natural cloud coverage b_ci</span>
    <span class="n">b_ci</span> <span class="o">=</span> <span class="n">r_ice</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">b_ci</span><span class="p">[</span><span class="n">R_s</span> <span class="o">&lt;</span> <span class="n">r_crit</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">b_ci</span><span class="p">[</span><span class="n">R_s</span> <span class="o">&gt;=</span> <span class="n">r_crit</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">R_s</span><span class="p">[</span><span class="n">R_s</span> <span class="o">&gt;=</span> <span class="n">r_crit</span><span class="p">]</span> <span class="o">-</span> <span class="n">r_crit</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r_sat</span> <span class="o">-</span> <span class="n">r_crit</span><span class="p">)))</span>

    <span class="c1"># calculation of cloud coverage + natural cirus B_cc_ci</span>
    <span class="n">B_cc_ci</span> <span class="o">=</span> <span class="n">r_ice</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">r_star</span> <span class="o">=</span> <span class="n">r_sat</span> <span class="o">-</span> <span class="p">(((</span><span class="n">r_crit</span> <span class="o">-</span> <span class="n">r_cc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r_sat</span> <span class="o">-</span> <span class="n">r_crit</span><span class="p">))</span>

    <span class="n">B_cc_ci</span><span class="p">[</span><span class="n">r_ice</span> <span class="o">&lt;</span> <span class="n">r_cc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">B_cc_ci</span><span class="p">[</span><span class="n">r_ice</span> <span class="o">&gt;=</span> <span class="n">r_cc</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">r_ice</span><span class="p">[</span><span class="n">r_ice</span> <span class="o">&gt;=</span> <span class="n">r_cc</span><span class="p">]</span> <span class="o">-</span> <span class="n">r_cc</span><span class="p">[</span><span class="n">r_ice</span> <span class="o">&gt;=</span> <span class="n">r_cc</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">r_sat</span> <span class="o">-</span> <span class="n">r_crit</span><span class="p">))</span> <span class="o">-</span> <span class="n">b_ci</span><span class="p">[</span><span class="n">r_ice</span> <span class="o">&gt;=</span> <span class="n">r_cc</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">b_ci</span><span class="p">[</span><span class="n">r_ice</span> <span class="o">&gt;=</span> <span class="n">r_cc</span><span class="p">])</span>
    <span class="n">B_cc_ci</span><span class="p">[</span><span class="n">r_ice</span> <span class="o">&gt;=</span> <span class="n">r_star</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Potential contrail cirus coverage</span>

    <span class="n">Bcc</span> <span class="o">=</span> <span class="n">B_cc_ci</span> <span class="o">-</span> <span class="n">b_ci</span>
    <span class="n">Bcc_temp</span> <span class="o">=</span> <span class="n">B_cc_ci</span> <span class="o">-</span> <span class="n">b_ci</span>

    <span class="n">Bcc_temp</span><span class="p">[</span><span class="n">T</span> <span class="o">&gt;=</span> <span class="n">t_contr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">Bcc</span><span class="p">,</span> <span class="n">Bcc_temp</span></div>


<div class="viewcode-block" id="get_rw_from_specific_hum"><a class="viewcode-back" href="../../modules.html#envlib.contrail.get_rw_from_specific_hum">[docs]</a><span class="k">def</span> <span class="nf">get_rw_from_specific_hum</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">member</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Calculates relative humidity over water from specific humidity.</span>

<span class="sd">    :param ds: Dataset openned with xarray.</span>
<span class="sd">    :type ds: Dataset</span>

<span class="sd">    :param member: Detemines the presense of ensemble forecasts in the given dataset.</span>
<span class="sd">    :type member: bool</span>

<span class="sd">    :returns r_w: Relative humidity over water.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">r_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kilogram</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">kilogram</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">level</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">member</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># In some versions of metpy, the order of specific humidity and pressure level are different.</span>
                <span class="n">r_w</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">relative_humidity_from_specific_humidity</span><span class="p">(</span><span class="n">sh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                                                                   <span class="n">t</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                                                                                   <span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">mbar</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">r_w</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">relative_humidity_from_specific_humidity</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">mbar</span><span class="p">,</span>
                                                                                   <span class="n">t</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                                                                                   <span class="n">sh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r_w</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">relative_humidity_from_specific_humidity</span><span class="p">(</span><span class="n">sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                                                                <span class="n">t</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                                                                                <span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">mbar</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">r_w</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">relative_humidity_from_specific_humidity</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">mbar</span><span class="p">,</span>
                                                                                <span class="n">t</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                                                                                <span class="n">sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span><span class="o">.</span><span class="n">magnitude</span>
    <span class="k">return</span> <span class="n">r_w</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">envlib</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=abolfazlsimorgh&repo=envlib&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#weather-store">Weather Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#calculation-of-accfs">Calculation of aCCFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#module-envlib.contrail">Persistent Contrails Formation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#module-envlib.calc_altrv_vars">Calculation of Alternative Variables</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Abolfazl Simorgh.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>