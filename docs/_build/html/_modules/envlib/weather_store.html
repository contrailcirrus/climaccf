
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>envlib.weather_store &#8212; envlib V0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for envlib.weather_store</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">convolve2d</span><span class="p">,</span> <span class="n">convolve</span>
<span class="kn">from</span> <span class="nn">envlib.extract_data</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">envlib.processing_surf_vars</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="get_bound_indexes"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.get_bound_indexes">[docs]</a><span class="k">def</span> <span class="nf">get_bound_indexes</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine indices of a given array (e.g., latitude and longitude) needed for cutting geographical areas with respect to the user-defined bounds.</span>

<span class="sd">    :param arr: a given array (e.g., latitude and longitude).</span>
<span class="sd">    :type arr: numpy.ndarray</span>

<span class="sd">    :param bounds: user-defined bounds.</span>
<span class="sd">    :type bounds: tuple</span>

<span class="sd">    :param verbose: Show determined indices.</span>
<span class="sd">    :type verbose: bool</span>

<span class="sd">    :returns slice(low, high): return the determined low and high indices of the given array that includes the</span>
<span class="sd">    defined bounds.</span>
<span class="sd">    :rtype: slice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[gbi] &quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>

    <span class="k">if</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">low</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">low</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bounds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">high</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">arr</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;high is </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
            <span class="n">high</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span></div>


<div class="viewcode-block" id="GeoArrayHandler"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.GeoArrayHandler">[docs]</a><span class="k">class</span> <span class="nc">GeoArrayHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">bitriangular_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">.</span><span class="mi">0625</span><span class="p">,</span> <span class="o">.</span><span class="mi">125</span><span class="p">,</span> <span class="o">.</span><span class="mi">0625</span><span class="p">],</span> <span class="p">[</span><span class="o">.</span><span class="mi">125</span><span class="p">,</span> <span class="o">.</span><span class="mi">25</span><span class="p">,</span> <span class="o">.</span><span class="mi">125</span><span class="p">],</span> <span class="p">[</span><span class="o">.</span><span class="mi">0625</span><span class="p">,</span> <span class="o">.</span><span class="mi">125</span><span class="p">,</span> <span class="o">.</span><span class="mi">0625</span><span class="p">]])</span>
    <span class="n">triangular_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">25</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">:</span> <span class="nb">dict</span>

<div class="viewcode-block" id="GeoArrayHandler.get_coords"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.GeoArrayHandler.get_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_axes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;predecimate&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">):</span>
                <span class="n">new_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[::</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_steps</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_axes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">new_axes</span></div>

<div class="viewcode-block" id="GeoArrayHandler.decimate"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.GeoArrayHandler.decimate">[docs]</a>    <span class="k">def</span> <span class="nf">decimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_steps</span><span class="p">):</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down2</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array</span></div>

<div class="viewcode-block" id="GeoArrayHandler.decimate_3d"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.GeoArrayHandler.decimate_3d">[docs]</a>    <span class="k">def</span> <span class="nf">decimate_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">arr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
            <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span> <span class="o">=</span> <span class="n">arr2</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">nlat</span><span class="p">,</span> <span class="p">:</span><span class="n">nlon</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr2</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">[:,</span> <span class="p">:</span><span class="n">nlat</span><span class="p">,</span> <span class="p">:</span><span class="n">nlon</span><span class="p">]</span></div>

<div class="viewcode-block" id="GeoArrayHandler.decimate_4d"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.GeoArrayHandler.decimate_4d">[docs]</a>    <span class="k">def</span> <span class="nf">decimate_4d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">arr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span> <span class="o">=</span> <span class="n">arr2</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:</span><span class="n">nlat</span><span class="p">,</span> <span class="p">:</span><span class="n">nlon</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr2</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">nlat</span><span class="p">,</span> <span class="p">:</span><span class="n">nlon</span><span class="p">]</span></div>

<div class="viewcode-block" id="GeoArrayHandler.decimate_5d"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.GeoArrayHandler.decimate_5d">[docs]</a>    <span class="k">def</span> <span class="nf">decimate_5d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">arr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                    <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span> <span class="o">=</span> <span class="n">arr2</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:</span><span class="n">nlat</span><span class="p">,</span> <span class="p">:</span><span class="n">nlon</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr2</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">nlat</span><span class="p">,</span> <span class="p">:</span><span class="n">nlon</span><span class="p">]</span></div>

<div class="viewcode-block" id="GeoArrayHandler.down2_coord"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.GeoArrayHandler.down2_coord">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">down2_coord</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span></div>

<div class="viewcode-block" id="GeoArrayHandler.down2"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.GeoArrayHandler.down2">[docs]</a>    <span class="k">def</span> <span class="nf">down2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decimates a 2D array by a factor of two after applying a triangular filter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Array to decimate must be 2D. Input has shape </span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">convolve2d</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitriangular_filter</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;symm&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;convolution_mode&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">filtered</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="WeatherStore_"><a class="viewcode-back" href="../../envlib.html#envlib.weather_store.WeatherStore_">[docs]</a><span class="k">class</span> <span class="nc">WeatherStore_</span><span class="p">(</span><span class="n">GeoArrayHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="WeatherStore"><a class="viewcode-back" href="../../modules.html#envlib.weather_store.WeatherStore">[docs]</a><span class="k">class</span> <span class="nc">WeatherStore</span><span class="p">(</span><span class="n">WeatherStore_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Prepare the data required to calculate aCCFs and store them in a xarray dataset.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="WeatherStore.__init__"><a class="viewcode-back" href="../../modules.html#envlib.weather_store.WeatherStore.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weather_data</span><span class="p">,</span> <span class="n">weather_data_sur</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flipud</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">weather_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes the weather data.</span>

<span class="sd">        :param weather_data: Dataset openned with xarray containing variables on different pressure levels.</span>
<span class="sd">        :type ds: Dataset</span>

<span class="sd">        :param weather_data_sur: Dataset openned with xarray containing variables on single pressure level (i.e., outgoing longwave radiation in this case).</span>
<span class="sd">        :type ds: Dataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># values array axes: times, levels, members, lats, lons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;downsample_format&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
            <span class="s1">&#39;ll_resolution&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;convolution_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;same&#39;</span><span class="p">,</span>
            <span class="s1">&#39;predecimate&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;save_as_xr&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>

        <span class="c1"># update configurations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">weather_config</span><span class="p">)</span>

        <span class="c1"># get information from wether data</span>
        <span class="n">inf_variables</span><span class="p">,</span> <span class="n">dict_var_attrs</span> <span class="o">=</span> <span class="n">extract_data_variables</span><span class="p">(</span><span class="n">weather_data</span><span class="p">,</span> <span class="n">weather_data_sur</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">inf_coordinates</span><span class="p">,</span> <span class="n">weather_data</span><span class="p">,</span> <span class="n">weather_data_sur</span><span class="p">,</span> <span class="n">dict_coor_attrs</span> <span class="o">=</span> <span class="n">extract_coordinates</span><span class="p">(</span><span class="n">weather_data</span><span class="p">,</span> <span class="n">inf_variables</span><span class="p">,</span>
                                                                              <span class="n">weather_data_sur</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_names</span> <span class="o">=</span> <span class="n">inf_variables</span><span class="p">[</span><span class="s1">&#39;ex_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_variable_names</span> <span class="o">=</span> <span class="n">inf_variables</span><span class="p">[</span><span class="s1">&#39;pre_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span> <span class="o">=</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;coor_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">member_bool</span> <span class="o">=</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates_bool</span> <span class="o">=</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinate_names</span> <span class="o">=</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;pre_coor_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aCCF_bool</span> <span class="o">=</span> <span class="n">logic_cal_accfs</span><span class="p">(</span><span class="n">inf_variables</span><span class="p">[</span><span class="s1">&#39;logic_variable&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;save_as_xr&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_xr</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coor_xr</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span> <span class="o">=</span> <span class="n">weather_data</span>
        <span class="c1"># check the consistency of lat-long fields within datasets of surface and pressure level parameters</span>
        <span class="c1"># TODO: Consider the range (i.e., on data set has latitude: (20, 60) and the other one latitude: (30, 70) --&gt; consider (30,60)) and also stick to lower resultion one</span>
        <span class="c1"># TODO: For the following condition, also check if merged aCCF is needed. If yes, search for shortwave flux, time or methods implemented by Ben for determining whether we have daytime contrails or not, the process ttr</span>
        <span class="k">if</span> <span class="n">weather_data_sur</span> <span class="ow">and</span> <span class="n">inf_variables</span><span class="p">[</span><span class="s1">&#39;logic_variable&#39;</span><span class="p">][</span><span class="s1">&#39;ttr&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span> <span class="o">=</span> <span class="n">weather_data_sur</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The latitude axis of the surface parameter is not consistent with the corresponding &quot;</span>
                                 <span class="s2">&quot;one within the dataset of pressure level parameters.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The longitude axis of the surface parameter is not consistent with the &quot;</span>
                                 <span class="s2">&quot;corresponding one within the dataset of pressure level parameters.&quot;</span><span class="p">)</span>

        <span class="c1"># check the name and order of coordinates selected properly</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; The axis </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> should be longitude&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;latitude&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; The axis </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> should be latitude&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; The axis </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> should be level&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; The axis </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> should be number&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; The axis </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> should be time&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; The axis </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2"> should be time&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">flipud</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">flipud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">flipud</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_members</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_members</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_members</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;ll_resolution&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd_resolution</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">downsample_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">downsample_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;ll_resolution&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd_resolution</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">downsample_steps</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;level&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">for</span> <span class="n">i_</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_names</span><span class="p">):</span>
            <span class="c1"># TODO: if needed, process shortwave flux here</span>
            <span class="n">tag_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_variable_names</span><span class="p">[</span><span class="n">i_</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tag_</span> <span class="o">==</span> <span class="s1">&#39;ttr&#39;</span> <span class="ow">or</span> <span class="n">tag_</span> <span class="o">==</span> <span class="s1">&#39;olr&#39;</span><span class="p">:</span>
                <span class="n">dict_var_attrs</span><span class="p">[</span><span class="s1">&#39;olr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;W m**-2&#39;</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Outgoing longwave radiation&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;toa_outgoing_longwave_flux&#39;</span><span class="p">}</span>
                <span class="n">tag_</span> <span class="o">=</span> <span class="s1">&#39;olr&#39;</span>
                <span class="k">if</span> <span class="n">flipud</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">get_olr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">get_olr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">get_olr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span>
                            <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">get_olr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="p">:,</span>
                            <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">tag_</span> <span class="o">==</span> <span class="s1">&#39;ssrd&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flipud</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">get_ssrd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">get_ssrd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">get_ssrd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span>
                            <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">get_ssrd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_sur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="p">:,</span>
                            <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flipud</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;predecimate&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">inf_coordinates</span><span class="p">[</span><span class="s1">&#39;logic_coordinate&#39;</span><span class="p">][</span><span class="s1">&#39;member&#39;</span><span class="p">]:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimate_5d</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimate_4d</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag_</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tag_</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;save_as_xr&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var_xr</span><span class="p">[</span><span class="n">tag_</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">),</span> <span class="n">A</span><span class="p">,</span> <span class="n">dict_var_attrs</span><span class="p">[</span><span class="n">tag_</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;predecimate&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][::</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_steps</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">][::</span><span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_steps</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;save_as_xr&#39;</span><span class="p">]:</span>
            <span class="n">ds_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_xr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span></div>
            <span class="c1">#ds_xr.to_netcdf(&#39;/Users/abolfazlsimorgh/Desktop/data.nc&#39;)</span>

<div class="viewcode-block" id="WeatherStore.get_xarray"><a class="viewcode-back" href="../../modules.html#envlib.weather_store.WeatherStore.get_xarray">[docs]</a>    <span class="k">def</span> <span class="nf">get_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new xarray dataset containing processed weather variables.</span>

<span class="sd">        :returns ds: xarray dataset containing user-defined variables (e.g., merged aCCFs, mean aCCFs, Climate hotspots).</span>
<span class="sd">        :rtype: dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_xr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span></div>

<div class="viewcode-block" id="WeatherStore.reduce_domain"><a class="viewcode-back" href="../../modules.html#envlib.weather_store.WeatherStore.reduce_domain">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduces horizontal domain and time.</span>

<span class="sd">        :param bounds: ranges defined as tuple (e.g., lat_bound=(35, 60.0)).</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slice_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">:</span>
            <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bti</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bti</span><span class="p">)</span> <span class="o">==</span> <span class="n">datetime</span><span class="p">:</span>
                    <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bti</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_idx</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">ax_name</span><span class="p">,</span> <span class="n">ax_bounds</span> <span class="ow">in</span> <span class="n">bounds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">slc</span> <span class="o">=</span> <span class="n">get_bound_indexes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">ax_name</span><span class="p">],</span> <span class="n">ax_bounds</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not reduce domain along the &#39;</span><span class="si">{</span><span class="n">ax_name</span><span class="si">}</span><span class="s2">&#39; axis&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current bounds: (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">ax_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">ax_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Desired bounds: </span><span class="si">{</span><span class="n">ax_bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="n">slice_idx</span><span class="p">[</span><span class="n">ax_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">slc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">ax_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">ax_name</span><span class="p">][</span><span class="n">slc</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_variable_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;ttr&#39;</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;olr&#39;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reducing domain from shape: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">member_bool</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="n">slice_idx</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                                   <span class="p">:,</span>  <span class="c1"># get all members</span>
                                   <span class="p">:,</span>  <span class="c1"># get all levels</span>
                                   <span class="n">slice_idx</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span>
                                   <span class="n">slice_idx</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="n">slice_idx</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                                   <span class="p">:,</span>  <span class="c1"># get all levels</span>
                                   <span class="n">slice_idx</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span>
                                   <span class="n">slice_idx</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_xr</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_names</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reducing domain to   shape: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">envlib</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=abolfazlsimorgh&repo=envlib&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#weather-store">Weather Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#calculation-of-accfs">Calculation of aCCFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#module-envlib.contrail">Persistent Contrails Formation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#module-envlib.calc_altrv_vars">Calculation of Alternative Variables</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Abolfazl Simorgh.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>